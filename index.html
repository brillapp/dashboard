<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ventas Offline (PWA)</title>
  <meta name="theme-color" content="#111827" />
  <link rel="manifest" href="manifest.json">
  <style>
    :root{--bg:#0b1220;--card:#0f172a;--muted:#94a3b8;--fg:#e5e7eb;--b:#1f2937;--acc:#22c55e;--bad:#ef4444;--warn:#f59e0b}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#050814,#0b1220);color:var(--fg)}
    header{position:sticky;top:0;background:rgba(5,8,20,.9);backdrop-filter: blur(8px);border-bottom:1px solid var(--b);z-index:10}
    .wrap{max-width:1150px;margin:0 auto;padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    h1{font-size:16px;margin:0}
    nav{display:flex;gap:8px;flex-wrap:wrap}
    button,.btn{border:1px solid var(--b);background:rgba(255,255,255,.03);color:var(--fg);padding:9px 10px;border-radius:12px;cursor:pointer}
    button:hover{border-color:#334155}
    .btn-primary{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.35)}
    .btn-danger{background:rgba(239,68,68,.10);border-color:rgba(239,68,68,.35)}
    .btn-ghost{background:transparent}
    main{padding:16px 0}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:920px){.grid.two{grid-template-columns:1fr 1fr}}
    .card{background:rgba(15,23,42,.85);border:1px solid var(--b);border-radius:16px;padding:12px}
    .card h2{font-size:14px;margin:0 0 10px 0;color:#cbd5e1}
    .muted{color:var(--muted);font-size:12px}
    input,select,textarea{width:100%;padding:10px;border-radius:12px;border:1px solid var(--b);background:rgba(255,255,255,.03);color:var(--fg);outline:none}
    textarea{min-height:78px;resize:vertical}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    td,th{font-size:12px;text-align:left;padding:8px 10px;vertical-align:top}
    tr{background:rgba(255,255,255,.02);border:1px solid var(--b)}
    tr td:first-child, tr th:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
    tr td:last-child, tr th:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:3px 8px;border-radius:999px;border:1px solid var(--b);font-size:11px;color:#cbd5e1}
    .ok{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.12)}
    .warn{border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.12)}
    .bad{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.10)}
    .kpi{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    @media(min-width:700px){.kpi{grid-template-columns:repeat(4,1fr)}}
    .k{padding:10px;border-radius:16px;border:1px solid var(--b);background:rgba(255,255,255,.02)}
    .k .v{font-size:18px;font-weight:700}
    .k .t{font-size:11px;color:var(--muted)}
    .flex{display:flex;gap:10px;flex-wrap:wrap}
    .right{margin-left:auto}
    .hr{height:1px;background:var(--b);margin:10px 0}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:rgba(2,6,23,.92);
      border:1px solid var(--b);padding:10px 12px;border-radius:999px;font-size:12px;display:none;z-index:20}
    .banner{border:1px solid rgba(245,158,11,.35);background:rgba(245,158,11,.10);border-radius:16px;padding:10px;margin-bottom:12px}
    .mini{font-size:11px;color:var(--muted)}
    .stop{border:1px solid var(--b);border-radius:16px;padding:10px;background:rgba(255,255,255,.02)}
    .stop.done{opacity:.55}
    .btn-xs{padding:6px 8px;border-radius:10px;font-size:12px}
  </style>
</head>
<body>
<header>
  <div class="wrap row">
    <div class="row" style="gap:12px;">
      <h1>Ventas Offline</h1>
      <span id="installHint" class="muted"></span>
      <span id="backupPill" class="pill warn" style="display:none;">Backup listo</span>
    </div>
    <nav>
      <button class="btn-ghost" data-view="dash">Dashboard</button>
      <button class="btn-ghost" data-view="rutas">Rutas</button>
      <button class="btn-ghost" data-view="clientes">Clientes</button>
      <button class="btn-ghost" data-view="productos">Productos</button>
      <button class="btn-ghost" data-view="pedidos">Pedidos</button>
      <button class="btn-ghost" data-view="visitas">Interacciones</button>
      <button class="btn-ghost" data-view="backup">Backup</button>
      <button class="btn-ghost" data-view="ajustes">Ajustes</button>
    </nav>
  </div>
</header>

<main class="wrap">
  <div id="view"></div>
</main>

<div class="toast" id="toast"></div>

<script>
/** =========================
 *  Utilidades
 *  ========================= */
const $ = (q, el=document)=>el.querySelector(q);
const $$ = (q, el=document)=>Array.from(el.querySelectorAll(q));
const fmtEur = (n)=> new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR'}).format(Number(n||0));
const fmtDate = (iso)=> iso ? new Date(iso).toLocaleDateString('es-ES') : '';
const fmtDateTime = (iso)=> iso ? new Date(iso).toLocaleString('es-ES') : '';
const nowISO = ()=> new Date().toISOString();
const uid = ()=> (crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()) + "-" + Math.random().toString(16).slice(2));
const daysBetween = (a,b)=> Math.round((new Date(b)-new Date(a))/(1000*60*60*24));
const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));

function toast(msg){
  const t = $("#toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(toast._tm);
  toast._tm = setTimeout(()=>t.style.display="none", 2400);
}

function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, (m)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  })[m]);
}

function isoDateOnly(d=new Date()){
  return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
}
function fromDateOnly(s){
  return s ? new Date(s + "T00:00:00").toISOString() : "";
}

/** =========================
 *  IndexedDB (DB local offline)
 *  ========================= */
const DB_NAME = "ventas_offline_db";
const DB_VER = 2; // <- subimos versión por backups/rutas/ajustes
let db;

function openDB(){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = (e)=>{
      const d = e.target.result;

      // v1 stores
      if(!d.objectStoreNames.contains("clientes")){
        const sClientes = d.createObjectStore("clientes", {keyPath:"id"});
        sClientes.createIndex("nombre","nombre",{unique:false});
        sClientes.createIndex("empresa","empresa",{unique:false});
        sClientes.createIndex("zona","zona",{unique:false});
      }

      if(!d.objectStoreNames.contains("productos")){
        const sProductos = d.createObjectStore("productos", {keyPath:"id"});
        sProductos.createIndex("nombre","nombre",{unique:false});
        sProductos.createIndex("categoria","categoria",{unique:false});
      }

      if(!d.objectStoreNames.contains("pedidos")){
        const sPedidos = d.createObjectStore("pedidos", {keyPath:"id"});
        sPedidos.createIndex("clienteId","clienteId",{unique:false});
        sPedidos.createIndex("fecha","fecha",{unique:false});
        sPedidos.createIndex("estado","estado",{unique:false});
      }

      if(!d.objectStoreNames.contains("visitas")){
        const sVisitas = d.createObjectStore("visitas", {keyPath:"id"});
        sVisitas.createIndex("clienteId","clienteId",{unique:false});
        sVisitas.createIndex("fecha","fecha",{unique:false});
        sVisitas.createIndex("tipo","tipo",{unique:false});
      }

      if(!d.objectStoreNames.contains("meta")){
        d.createObjectStore("meta", {keyPath:"key"});
      }

      // v2 new stores
      if(!d.objectStoreNames.contains("backups")){
        const sB = d.createObjectStore("backups", {keyPath:"id"});
        sB.createIndex("createdAt","createdAt",{unique:false});
      }

      if(!d.objectStoreNames.contains("rutas")){
        const sR = d.createObjectStore("rutas", {keyPath:"id"});
        sR.createIndex("date","date",{unique:false});
        sR.createIndex("zona","zona",{unique:false});
        sR.createIndex("status","status",{unique:false});
      }

      if(!d.objectStoreNames.contains("settings")){
        d.createObjectStore("settings", {keyPath:"key"});
      }
    };
    req.onsuccess = ()=>{ db=req.result; resolve(db); };
    req.onerror = ()=>reject(req.error);
  });
}

function tx(store, mode="readonly"){
  return db.transaction(store, mode).objectStore(store);
}

function dbPut(store, obj){
  return new Promise((resolve,reject)=>{
    const r = tx(store,"readwrite").put(obj);
    r.onsuccess=()=>resolve(obj);
    r.onerror=()=>reject(r.error);
  });
}
function dbDel(store, id){
  return new Promise((resolve,reject)=>{
    const r = tx(store,"readwrite").delete(id);
    r.onsuccess=()=>resolve(true);
    r.onerror=()=>reject(r.error);
  });
}
function dbGet(store, id){
  return new Promise((resolve,reject)=>{
    const r = tx(store,"readonly").get(id);
    r.onsuccess=()=>resolve(r.result||null);
    r.onerror=()=>reject(r.error);
  });
}
function dbAll(store){
  return new Promise((resolve,reject)=>{
    const r = tx(store,"readonly").getAll();
    r.onsuccess=()=>resolve(r.result||[]);
    r.onerror=()=>reject(r.error);
  });
}
function dbClear(store){
  return new Promise((resolve,reject)=>{
    const r = tx(store,"readwrite").clear();
    r.onsuccess=()=>resolve(true);
    r.onerror=()=>reject(r.error);
  });
}

/** =========================
 *  Settings (auto-backup, ruta sugerida...)
 *  ========================= */
const DEFAULT_SETTINGS = {
  autoBackupEnabled: true,
  autoBackupEveryDays: 7,
  keepBackups: 10,
  routeDefaultStops: 8,
  routeOnlyDue: true
};

async function loadSettings(){
  const out = {...DEFAULT_SETTINGS};
  for(const k of Object.keys(DEFAULT_SETTINGS)){
    const v = await dbGet("settings", k);
    if(v && v.value !== undefined) out[k] = v.value;
  }
  return out;
}
async function saveSetting(key, value){
  await dbPut("settings", {key, value});
}

/** =========================
 *  Datos demo (seed)
 *  ========================= */
async function ensureSeed(){
  const meta = await dbGet("meta","seeded");
  if(meta?.value) return;

  const c1 = {id:uid(), nombre:"María López", apodo:"Mari", empresa:"Cafés Costa", zona:"Pontevedra Centro", direccion:"C/ Mayor 12, Pontevedra", telefono:"600111222", email:"", notas:"Prefiere entregas por la mañana", estado:"activo", etiquetas:["alto volumen"], frecuenciaObjetivoDias:21, horarioPreferido:"mañana", creadoEn:nowISO()};
  const c2 = {id:uid(), nombre:"Daniel Pérez", apodo:"Dani", empresa:"Bar Atlántico", zona:"Vigo", direccion:"Av. Mar 4, Vigo", telefono:"", email:"", notas:"Pide producto A cada 2-3 semanas", estado:"activo", etiquetas:["recurrente"], frecuenciaObjetivoDias:18, horarioPreferido:"tarde", creadoEn:nowISO()};
  const c3 = {id:uid(), nombre:"Laura Gil", apodo:"Lau", empresa:"Hotel Rías", zona:"Sanxenxo", direccion:"Rúa Praia 9, Sanxenxo", telefono:"", email:"", notas:"Muy sensible al precio", estado:"potencial", etiquetas:["potencial"], frecuenciaObjetivoDias:30, horarioPreferido:"mañana", creadoEn:nowISO()};

  const p1 = {id:uid(), nombre:"Café Molido 1kg", descripcion:"Blend 100% arábica", categoria:"Café", sku:"CAF-1KG", precio:14.90, coste:8.10, unidad:"ud", iva:10, activo:true, creadoEn:nowISO()};
  const p2 = {id:uid(), nombre:"Cápsulas Pack 100", descripcion:"Compatibles", categoria:"Cápsulas", sku:"CAP-100", precio:29.90, coste:16.00, unidad:"pack", iva:10, activo:true, creadoEn:nowISO()};
  const p3 = {id:uid(), nombre:"Té Verde 250g", descripcion:"Premium", categoria:"Té", sku:"TE-250", precio:9.90, coste:4.50, unidad:"ud", iva:10, activo:true, creadoEn:nowISO()};

  await dbPut("clientes", c1); await dbPut("clientes", c2); await dbPut("clientes", c3);
  await dbPut("productos", p1); await dbPut("productos", p2); await dbPut("productos", p3);

  const ped1 = {
    id:uid(),
    clienteId:c1.id,
    fecha:new Date(Date.now()-1000*60*60*24*35).toISOString(),
    fechaEntrega:new Date(Date.now()-1000*60*60*24*33).toISOString(),
    estado:"entregado",
    canal:"visita",
    comercial:"yo",
    notas:"Entrega ok",
    lineas:[
      {id:uid(), productoId:p1.id, nombre:p1.nombre, cantidad:4, precioUnit:14.90, descuentoPct:0, total:0},
      {id:uid(), productoId:p2.id, nombre:p2.nombre, cantidad:1, precioUnit:29.90, descuentoPct:5, total:0},
    ],
    total:0,
    creadoEn:nowISO()
  };
  recomputePedido(ped1);

  const ped2 = {
    id:uid(),
    clienteId:c2.id,
    fecha:new Date(Date.now()-1000*60*60*24*12).toISOString(),
    fechaEntrega:"",
    estado:"confirmado",
    canal:"whatsapp",
    comercial:"yo",
    notas:"",
    lineas:[
      {id:uid(), productoId:p1.id, nombre:p1.nombre, cantidad:2, precioUnit:14.90, descuentoPct:0, total:0},
      {id:uid(), productoId:p3.id, nombre:p3.nombre, cantidad:2, precioUnit:9.90, descuentoPct:0, total:0},
    ],
    total:0,
    creadoEn:nowISO()
  };
  recomputePedido(ped2);

  await dbPut("pedidos", ped1); await dbPut("pedidos", ped2);
  await dbPut("visitas", {id:uid(), clienteId:c2.id, fecha:new Date(Date.now()-1000*60*60*24*7).toISOString(), tipo:"llamada", resultado:"pendiente", notas:"Quiere ver nueva tarifa", creadoEn:nowISO()});

  await dbPut("meta",{key:"seeded", value:true});
}

/** =========================
 *  Pedidos: totals
 *  ========================= */
function lineTotal(l){
  const qty = Number(l.cantidad||0);
  const pu = Number(l.precioUnit||0);
  const disc = Number(l.descuentoPct||0);
  const t = qty * pu * (1 - disc/100);
  return Math.round(t*1000)/1000;
}
function recomputePedido(p){
  (p.lineas||[]).forEach(l=>l.total=lineTotal(l));
  p.total = Math.round((p.lineas||[]).reduce((a,l)=>a+Number(l.total||0),0)*1000)/1000;
  return p;
}

/** =========================
 *  KPIs + scoring rutas
 *  ========================= */
function calcKpis(clientes, productos, pedidos){
  const pedidosOK = pedidos.filter(p=>["entregado","confirmado"].includes(p.estado));
  const totalVentas = pedidosOK.reduce((a,p)=>a+Number(p.total||0),0);
  const nPedidos = pedidosOK.length;
  const ticketMedio = nPedidos ? totalVentas/nPedidos : 0;

  const lim30 = Date.now() - 1000*60*60*24*30;
  const ventas30 = pedidosOK.filter(p=> new Date(p.fecha).getTime() >= lim30)
    .reduce((a,p)=>a+Number(p.total||0),0);

  // Top productos por importe
  const mapProd = new Map();
  for(const p of pedidosOK){
    for(const l of (p.lineas||[])){
      mapProd.set(l.productoId, (mapProd.get(l.productoId)||0) + Number(l.total||0));
    }
  }
  const topProd = Array.from(mapProd.entries())
    .map(([id,tot])=>({id, tot}))
    .sort((a,b)=>b.tot-a.tot)
    .slice(0,10)
    .map(x=>{
      const pr = productos.find(pp=>pp.id===x.id);
      return {nombre: pr?.nombre || "Producto", total:x.tot};
    });

  // Stats por cliente + “riesgo”
  const porCliente = new Map();
  for(const p of pedidosOK){
    if(!porCliente.has(p.clienteId)) porCliente.set(p.clienteId, []);
    porCliente.get(p.clienteId).push(p);
  }

  const riesgo = [];
  const statsCliente = [];

  for(const c of clientes){
    const arr = (porCliente.get(c.id)||[]).sort((a,b)=> new Date(a.fecha)-new Date(b.fecha));
    const fechas = arr.map(x=>x.fecha);

    let media = null;
    if(fechas.length>=2){
      const deltas=[];
      for(let i=1;i<fechas.length;i++) deltas.push(daysBetween(fechas[i-1], fechas[i]));
      media = deltas.reduce((a,d)=>a+d,0)/deltas.length;
    }

    const ultimo = fechas.length ? fechas[fechas.length-1] : null;
    const diasDesdeUltimo = ultimo ? daysBetween(ultimo, nowISO()) : 999;

    const objetivo = Number(c.frecuenciaObjetivoDias||0) || (media ? Math.round(media) : 30);
    const umbral = Math.round(objetivo*1.5);
    const enRiesgo = ultimo ? (diasDesdeUltimo > umbral) : false;

    const total = arr.reduce((a,p)=>a+Number(p.total||0),0);
    statsCliente.push({
      cliente: c,
      total,
      pedidos: arr.length,
      diasDesdeUltimo,
      objetivo,
      mediaEntrePedidos: media,
      ultimoPedido: ultimo
    });

    if(enRiesgo){
      riesgo.push({cliente:c, dias:diasDesdeUltimo, umbral});
    }
  }

  statsCliente.sort((a,b)=>b.total-a.total);
  riesgo.sort((a,b)=>b.dias-a.dias);

  return { totalVentas, nPedidos, ticketMedio, ventas30, topProd, riesgo, statsCliente };
}

/**
 * Score para rutas (prioridad):
 * - parte principal: ratio = diasDesdeUltimo / objetivo
 * - sube con ventas (para priorizar grandes)
 * - sube si es "activo"
 * - baja si está inactivo/potencial
 */
function scoreCliente(stat){
  const c = stat.cliente;
  const ratio = stat.objetivo ? (stat.diasDesdeUltimo / stat.objetivo) : 0;
  const ratioScore = clamp(ratio, 0, 3) * 60; // hasta 180
  const ventasScore = clamp(Math.log10((stat.total||0) + 1), 0, 5) * 12; // hasta 60
  const estadoAdj = c.estado==="activo" ? 12 : (c.estado==="potencial" ? -4 : -10);
  return Math.round(ratioScore + ventasScore + estadoAdj);
}

function clasePrioridad(stat){
  const ratio = stat.objetivo ? (stat.diasDesdeUltimo / stat.objetivo) : 0;
  if(ratio >= 1.5) return "bad";
  if(ratio >= 1.0) return "warn";
  return "ok";
}

function proximaVisitaSugerida(stat){
  if(!stat.ultimoPedido) return "";
  const base = new Date(stat.ultimoPedido);
  base.setDate(base.getDate() + (stat.objetivo||30));
  return base.toISOString();
}

/** =========================
 *  Auto-backup (snapshot local)
 *  ========================= */
async function createSnapshot(reason="auto"){
  const [clientes, productos, pedidos, visitas] = await Promise.all([
    dbAll("clientes"), dbAll("productos"), dbAll("pedidos"), dbAll("visitas")
  ]);

  const payload = {
    version: 1,
    reason,
    createdAt: nowISO(),
    clientes, productos, pedidos, visitas
  };

  const snap = { id: uid(), createdAt: payload.createdAt, reason, payload };
  await dbPut("backups", snap);
  await dbPut("meta", {key:"lastSnapshotAt", value: payload.createdAt});
  await dbPut("meta", {key:"latestBackupReady", value: true});

  // recortar backups antiguos
  const settings = await loadSettings();
  const keep = Number(settings.keepBackups||10);
  const all = (await dbAll("backups")).sort((a,b)=> new Date(b.createdAt)-new Date(a.createdAt));
  for(let i=keep;i<all.length;i++){
    await dbDel("backups", all[i].id);
  }
  updateBackupPill();
}

async function checkAutoBackup(){
  const settings = await loadSettings();
  if(!settings.autoBackupEnabled) return;

  const last = await dbGet("meta","lastSnapshotAt");
  const lastAt = last?.value ? new Date(last.value) : null;
  const every = Number(settings.autoBackupEveryDays||7);

  // Si nunca hay snapshot -> crea uno
  if(!lastAt){
    await createSnapshot("auto-first");
    toast("Backup automático creado (1ª vez)");
    return;
  }

  const diffDays = daysBetween(lastAt.toISOString(), nowISO());
  if(diffDays >= every){
    await createSnapshot("auto");
    toast("Backup automático creado");
  }
}

async function updateBackupPill(){
  const m = await dbGet("meta","latestBackupReady");
  const pill = $("#backupPill");
  pill.style.display = m?.value ? "" : "none";
  pill.onclick = ()=> setView("backup");
}

/** =========================
 *  PWA: Service Worker
 *  ========================= */
async function setupPWA(){
  const hint = $("#installHint");
  const isStandalone = window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone;
  hint.textContent = isStandalone ? "Modo app · Offline" : "Instalable · Offline";

  if("serviceWorker" in navigator){
    try{ await navigator.serviceWorker.register("./sw.js"); }
    catch(e){ console.warn("SW no registrado", e); }
  }
}

/** =========================
 *  Estado UI
 *  ========================= */
let STATE = { view:"dash", editing:null };

function setView(v){ STATE.view=v; STATE.editing=null; render(); }

/** =========================
 *  Render router
 *  ========================= */
async function render(){
  const el = $("#view");
  const [clientes, productos, pedidos, visitas, rutas] = await Promise.all([
    dbAll("clientes"), dbAll("productos"), dbAll("pedidos"), dbAll("visitas"), dbAll("rutas")
  ]);

  if(STATE.view==="dash") return renderDash(el, clientes, productos, pedidos);
  if(STATE.view==="rutas") return renderRutas(el, clientes, productos, pedidos, visitas, rutas);
  if(STATE.view==="clientes") return renderClientes(el, clientes);
  if(STATE.view==="productos") return renderProductos(el, productos);
  if(STATE.view==="pedidos") return renderPedidos(el, clientes, productos, pedidos);
  if(STATE.view==="visitas") return renderVisitas(el, clientes, visitas);
  if(STATE.view==="backup") return renderBackup(el);
  if(STATE.view==="ajustes") return renderAjustes(el);
  el.innerHTML = `<div class="card">Vista no encontrada</div>`;
}

/** =========================
 *  DASHBOARD
 *  ========================= */
function renderDash(el, clientes, productos, pedidos){
  const k = calcKpis(clientes, productos, pedidos);

  const topClientes = k.statsCliente.slice(0,12);
  const riesgo = k.riesgo.slice(0,10);

  el.innerHTML = `
    <div class="grid">
      <div class="card">
        <h2>KPIs</h2>
        <div class="kpi">
          <div class="k"><div class="v">${fmtEur(k.totalVentas)}</div><div class="t">Ventas (confirmado/entregado)</div></div>
          <div class="k"><div class="v">${k.nPedidos}</div><div class="t">Nº pedidos</div></div>
          <div class="k"><div class="v">${fmtEur(k.ticketMedio)}</div><div class="t">Ticket medio</div></div>
          <div class="k"><div class="v">${fmtEur(k.ventas30)}</div><div class="t">Ventas últimos 30 días</div></div>
        </div>

        <div class="hr"></div>
        <div class="grid two">
          <div class="card" style="margin:0">
            <h2>Top productos</h2>
            ${k.topProd.length ? `
              <table>
                <thead><tr><th>Producto</th><th>Total</th></tr></thead>
                <tbody>
                  ${k.topProd.map(x=>`<tr><td>${escapeHtml(x.nombre)}</td><td>${fmtEur(x.total)}</td></tr>`).join("")}
                </tbody>
              </table>` : `<div class="muted">Aún no hay datos.</div>`}
          </div>

          <div class="card" style="margin:0">
            <h2>Clientes en riesgo</h2>
            ${riesgo.length ? `
              <table>
                <thead><tr><th>Cliente</th><th>Días sin pedido</th><th>Umbral</th></tr></thead>
                <tbody>
                  ${riesgo.map(r=>`<tr><td>${escapeHtml(r.cliente.nombre)} <span class="muted">(${escapeHtml(r.cliente.empresa||"")})</span></td><td>${r.dias}</td><td>${r.umbral}</td></tr>`).join("")}
                </tbody>
              </table>` : `<span class="pill ok">Todo al día</span>`}
            <div class="mini">Regla simple: “riesgo” si supera 1,5× la frecuencia objetivo.</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="row">
          <h2>Ranking clientes (ventas + planificación)</h2>
          <div class="right">
            <button class="btn-primary" id="goRutas">Ir a Rutas</button>
          </div>
        </div>

        ${topClientes.length ? `
          <table>
            <thead><tr><th>Cliente</th><th>Ventas</th><th>Pedidos</th><th>Último pedido</th><th>Prioridad</th><th>Próxima sugerida</th></tr></thead>
            <tbody>
              ${topClientes.map(s=>{
                const cls = clasePrioridad(s);
                const pr = proximaVisitaSugerida(s);
                const sc = scoreCliente(s);
                return `<tr>
                  <td>
                    ${escapeHtml(s.cliente.nombre)} <span class="muted">${escapeHtml(s.cliente.empresa||"")}</span><br>
                    <span class="mini">${escapeHtml(s.cliente.zona||"")}</span>
                  </td>
                  <td>${fmtEur(s.total)}</td>
                  <td>${s.pedidos}</td>
                  <td>${s.ultimoPedido ? fmtDate(s.ultimoPedido) : "-"}</td>
                  <td><span class="pill ${cls}">${sc} pts · ${s.diasDesdeUltimo}d/${s.objetivo}d</span></td>
                  <td>${pr ? fmtDate(pr) : "-"}</td>
                </tr>`;
              }).join("")}
            </tbody>
          </table>` : `<div class="muted">Crea clientes y pedidos para ver estadísticas.</div>`}
      </div>
    </div>
  `;

  $("#goRutas").onclick = ()=> setView("rutas");
}

/** =========================
 *  RUTAS / VISITAS (MEJORA #2)
 *  ========================= */
function renderRutas(el, clientes, productos, pedidos, visitas, rutas){
  const k = calcKpis(clientes, productos, pedidos);
  const settingsPromise = loadSettings();

  // Zonas disponibles
  const zonas = Array.from(new Set(clientes.map(c=>c.zona).filter(Boolean))).sort((a,b)=>a.localeCompare(b));

  const hoy = isoDateOnly(new Date());
  const rutaHoy = rutas.slice().sort((a,b)=> new Date(b.date)-new Date(a.date)).find(r=>r.date===hoy) || null;

  el.innerHTML = `
    <div class="banner">
      <div class="row">
        <div>
          <b>Rutas/Visitas</b>
          <div class="mini">Genera una lista de paradas por prioridad, filtra por zona, y registra interacciones con un toque.</div>
        </div>
        <div class="right flex">
          <button class="btn" id="btnNuevaRuta">+ Nueva ruta</button>
          <button class="btn-primary" id="btnGenerarRuta">Generar sugerida</button>
        </div>
      </div>
    </div>

    <div class="grid two">
      <div class="card">
        <h2>Planificador</h2>
        <div class="grid two">
          <div>
            <label>Fecha</label>
            <input id="rutaFecha" type="date" value="${hoy}">
          </div>
          <div>
            <label>Zona (opcional)</label>
            <select id="rutaZona">
              <option value="">Todas</option>
              ${zonas.map(z=>`<option value="${escapeHtml(z)}">${escapeHtml(z)}</option>`).join("")}
            </select>
          </div>
        </div>

        <div class="grid two">
          <div>
            <label>Nº paradas sugeridas</label>
            <input id="rutaStops" type="number" min="1" max="30" value="8">
          </div>
          <div>
            <label>Incluir solo “vencidos” (días ≥ objetivo)</label>
            <select id="rutaOnlyDue">
              <option value="true">sí</option>
              <option value="false">no</option>
            </select>
          </div>
        </div>

        <div class="hr"></div>
        <div class="muted">Criterio: prioridad = (días desde último / objetivo) + peso por ventas + estado. Ajustable luego.</div>
        <div class="hr"></div>

        <div class="row">
          <div class="pill ok">Clientes activos: ${clientes.filter(c=>c.estado==="activo").length}</div>
          <div class="pill warn">Riesgo: ${k.riesgo.length}</div>
          <div class="pill">Pedidos OK: ${k.nPedidos}</div>
        </div>

        <div class="hr"></div>
        <h2 style="margin-top:0">Top candidatos (según prioridad)</h2>
        <div id="candidatos"></div>
      </div>

      <div class="card">
        <div class="row">
          <h2>Ruta del día</h2>
          <div class="right flex">
            <button class="btn" id="btnGuardarRuta">Guardar</button>
            <button class="btn-danger" id="btnBorrarRuta">Borrar</button>
          </div>
        </div>
        <div class="muted">Ordena paradas, marca completadas y registra interacción.</div>
        <div class="hr"></div>
        <div id="rutaBox"></div>
      </div>
    </div>
  `;

  // Inicializar controles con settings
  (async ()=>{
    const settings = await settingsPromise;
    $("#rutaStops").value = Number(settings.routeDefaultStops||8);
    $("#rutaOnlyDue").value = String(!!settings.routeOnlyDue);

    renderCandidatos();
    renderRuta(rutaHoy);

    $("#btnNuevaRuta").onclick = ()=>{
      renderRuta({id:uid(), date:$("#rutaFecha").value, zona:$("#rutaZona").value, status:"draft", stops:[]});
      toast("Ruta nueva (borrador)");
    };

    $("#btnGenerarRuta").onclick = ()=>{
      const date = $("#rutaFecha").value || hoy;
      const zona = $("#rutaZona").value || "";
      const n = Number($("#rutaStops").value||8);
      const onlyDue = ($("#rutaOnlyDue").value==="true");

      const candidatos = buildCandidates(zona, onlyDue);
      const selected = candidatos.slice(0,n).map(x=>({
        stopId: uid(),
        clienteId: x.cliente.id,
        done:false,
        note:""
      }));

      const r = { id: uid(), date, zona, status:"draft", createdAt: nowISO(), stops: selected };
      renderRuta(r);
      toast("Ruta sugerida generada");
    };

    $("#btnGuardarRuta").onclick = async ()=>{
      const ruta = readRutaFromUI();
      if(!ruta) return;
      await dbPut("rutas", ruta);
      toast("Ruta guardada");
    };

    $("#btnBorrarRuta").onclick = async ()=>{
      const ruta = readRutaFromUI();
      if(!ruta?.id) return toast("No hay ruta");
      if(!confirm("¿Borrar esta ruta?")) return;
      await dbDel("rutas", ruta.id);
      toast("Ruta borrada");
      renderRuta(null);
    };

    $("#rutaFecha").onchange = ()=>{
      // si hay una ruta guardada para esa fecha, la carga
      const date = $("#rutaFecha").value;
      const found = rutas.find(r=>r.date===date && (r.zona||"")==($("#rutaZona").value||""));
      renderRuta(found||null);
      renderCandidatos();
    };

    $("#rutaZona").onchange = ()=>{
      renderCandidatos();
      const date = $("#rutaFecha").value;
      const zona = $("#rutaZona").value || "";
      const found = rutas.find(r=>r.date===date && (r.zona||"")==zona);
      renderRuta(found||null);
    };

    $("#rutaStops").oninput = ()=>{};
    $("#rutaOnlyDue").onchange = ()=> renderCandidatos();
  })();

  function buildCandidates(zona, onlyDue){
    const stats = k.statsCliente.slice(); // ya incluye total, dias, objetivo...
    const filtered = stats
      .filter(s=> s.cliente.estado!=="inactivo")
      .filter(s=> zona ? (s.cliente.zona||"")===zona : true)
      .map(s=>({...s, score: scoreCliente(s), cls: clasePrioridad(s)}))
      .filter(s=> onlyDue ? (s.diasDesdeUltimo >= (s.objetivo||30)) : true)
      .sort((a,b)=> b.score - a.score);

    // Si hay potenciales sin pedidos, empújalos al final
    return filtered;
  }

  function renderCandidatos(){
    const zona = $("#rutaZona").value || "";
    const onlyDue = ($("#rutaOnlyDue").value==="true");
    const cand = buildCandidates(zona, onlyDue).slice(0,15);

    const box = $("#candidatos");
    if(!cand.length){
      box.innerHTML = `<div class="muted">No hay candidatos con esos filtros.</div>`;
      return;
    }

    box.innerHTML = `
      ${cand.map(s=>{
        const pr = proximaVisitaSugerida(s);
        return `
          <div class="stop">
            <div class="row">
              <div>
                <b>${escapeHtml(s.cliente.nombre)}</b> <span class="muted">${escapeHtml(s.cliente.empresa||"")}</span><br>
                <span class="mini">${escapeHtml(s.cliente.zona||"")} · objetivo ${s.objetivo}d · ${s.diasDesdeUltimo}d desde último</span>
              </div>
              <div class="right">
                <span class="pill ${s.cls}">${s.score} pts</span>
              </div>
            </div>
            <div class="mini" style="margin-top:6px">
              Ventas: ${fmtEur(s.total)} · Próxima sugerida: ${pr ? fmtDate(pr) : "-"}
            </div>
            <div class="flex" style="margin-top:10px">
              <button class="btn-primary btn-xs" data-act="add" data-id="${s.cliente.id}">Añadir a ruta</button>
              <button class="btn btn-xs" data-act="call" data-id="${s.cliente.id}">Registrar llamada</button>
              <button class="btn btn-xs" data-act="visit" data-id="${s.cliente.id}">Registrar visita</button>
            </div>
          </div>
        `;
      }).join("")}
    `;

    box.onclick = async (e)=>{
      const b = e.target.closest("button");
      if(!b) return;
      const id = b.dataset.id;
      const act = b.dataset.act;
      if(!id) return;

      if(act==="add"){
        addStopToRuta(id);
        toast("Añadido a ruta");
      }
      if(act==="call"){
        await quickInteraction(id, "llamada");
        toast("Llamada registrada");
      }
      if(act==="visit"){
        await quickInteraction(id, "visita");
        toast("Visita registrada");
      }
    };
  }

  async function quickInteraction(clienteId, tipo){
    const date = $("#rutaFecha").value || hoy;
    await dbPut("visitas", {
      id: uid(),
      clienteId,
      fecha: fromDateOnly(date),
      tipo,
      resultado: "ok",
      notas: "",
      creadoEn: nowISO()
    });
  }

  function renderRuta(ruta){
    const box = $("#rutaBox");
    if(!ruta || !ruta.stops){
      box.innerHTML = `<div class="muted">No hay ruta cargada. Genera una sugerida o crea una nueva.</div>`;
      box.dataset.routeId = "";
      return;
    }
    box.dataset.routeId = ruta.id || "";
    box.dataset.routeDate = ruta.date || hoy;
    box.dataset.routeZona = ruta.zona || "";
    box.dataset.routeStatus = ruta.status || "draft";

    if(!ruta.stops.length){
      box.innerHTML = `<div class="muted">Ruta vacía. Añade paradas desde “Top candidatos”.</div>`;
      return;
    }

    box.innerHTML = ruta.stops.map((st, idx)=>{
      const c = clientes.find(x=>x.id===st.clienteId);
      const doneClass = st.done ? "done" : "";
      return `
        <div class="stop ${doneClass}" data-stop="${st.stopId}">
          <div class="row">
            <div>
              <b>${idx+1}. ${escapeHtml(c?.nombre||"")}</b> <span class="muted">${escapeHtml(c?.empresa||"")}</span><br>
              <span class="mini">${escapeHtml(c?.zona||"")} · ${escapeHtml(c?.direccion||"")}</span>
            </div>
            <div class="right flex">
              <button class="btn btn-xs" data-act="up">↑</button>
              <button class="btn btn-xs" data-act="down">↓</button>
              <button class="btn btn-xs" data-act="done">${st.done ? "Reabrir" : "Hecho"}</button>
              <button class="btn-primary btn-xs" data-act="log">Registrar</button>
              <button class="btn-danger btn-xs" data-act="remove">Quitar</button>
            </div>
          </div>

          <label>Nota (solo ruta)</label>
          <input data-role="note" value="${escapeHtml(st.note||"")}">

          <div class="mini" style="margin-top:6px">
            Acceso rápido: ${escapeHtml(c?.telefono||"")} · ${escapeHtml(c?.email||"")}
          </div>
        </div>
      `;
    }).join("");

    box.onclick = async (e)=>{
      const b = e.target.closest("button");
      if(!b) return;
      const stopEl = e.target.closest(".stop");
      const stopId = stopEl?.dataset?.stop;
      if(!stopId) return;

      const act = b.dataset.act;
      if(act==="up") moveStop(stopId, -1);
      if(act==="down") moveStop(stopId, +1);
      if(act==="remove") removeStop(stopId);
      if(act==="done") toggleDone(stopId);
      if(act==="log") await logStop(stopId);
    };

    box.oninput = (e)=>{
      const inp = e.target.closest('input[data-role="note"]');
      if(!inp) return;
      const stopEl = e.target.closest(".stop");
      const stopId = stopEl?.dataset?.stop;
      if(!stopId) return;
      setStopNote(stopId, inp.value);
    };
  }

  function readRutaFromUI(){
    const box = $("#rutaBox");
    const routeId = box.dataset.routeId;
    const routeDate = $("#rutaFecha").value || hoy;
    const routeZona = $("#rutaZona").value || "";
    const routeStatus = box.dataset.routeStatus || "draft";

    // Si no hay stops en DOM, intenta devolver null si no hay routeId
    const stopEls = $$("#rutaBox .stop");
    if(!stopEls.length && !routeId) return null;

    const stops = stopEls.map(el=>{
      const stopId = el.dataset.stop;
      const note = el.querySelector('input[data-role="note"]')?.value || "";
      const done = el.classList.contains("done");
      // clienteId lo guardamos en un atributo oculto buscando en la estructura actual:
      // lo resolvemos por el orden en la ruta actual guardada en memoria (simple: leemos del box actual)
      // Para mantener robustez, guardamos clienteId en dataset al render:
      return { stopId, note, done, clienteId: el.dataset.clienteId };
    });

    // Como arriba no hay dataset.clienteId, lo reconstruimos a partir del HTML: lo guardamos en stopEl con setClientId
    // (ver addStopToRuta / renderRuta hooks). Si no está, intentamos por matching nombre (último recurso).
    const stopsFixed = stopEls.map(el=>{
      const stopId = el.dataset.stop;
      const note = el.querySelector('input[data-role="note"]')?.value || "";
      const done = el.classList.contains("done");
      const cid = el.dataset.clienteId || "";
      return { stopId, clienteId: cid, done, note };
    }).filter(x=>x.clienteId);

    return {
      id: routeId || uid(),
      date: routeDate,
      zona: routeZona,
      status: routeStatus,
      updatedAt: nowISO(),
      createdAt: nowISO(),
      stops: stopsFixed
    };
  }

  function getCurrentRutaObject(){
    // Reconstruir desde DOM (incluye clienteId desde dataset)
    const box = $("#rutaBox");
    const routeId = box.dataset.routeId || uid();
    const date = $("#rutaFecha").value || hoy;
    const zona = $("#rutaZona").value || "";
    const status = box.dataset.routeStatus || "draft";
    const stopEls = $$("#rutaBox .stop");
    const stops = stopEls.map(el=>({
      stopId: el.dataset.stop,
      clienteId: el.dataset.clienteId,
      done: el.classList.contains("done"),
      note: el.querySelector('input[data-role="note"]')?.value || ""
    })).filter(x=>x.clienteId);
    return { id: routeId, date, zona, status, updatedAt: nowISO(), createdAt: nowISO(), stops };
  }

  function addStopToRuta(clienteId){
    let ruta = getCurrentRutaObject();

    if(!ruta.stops.find(s=>s.clienteId===clienteId)){
      ruta.stops.push({ stopId: uid(), clienteId, done:false, note:"" });
    }
    // volver a render con dataset.clienteId
    renderRutaWithClientId(ruta);
  }

  function renderRutaWithClientId(ruta){
    // renderRuta no está poniendo dataset.clienteId; aquí lo hacemos bien.
    const box = $("#rutaBox");
    box.dataset.routeId = ruta.id || "";
    box.dataset.routeDate = ruta.date || hoy;
    box.dataset.routeZona = ruta.zona || "";
    box.dataset.routeStatus = ruta.status || "draft";

    if(!ruta.stops.length){
      box.innerHTML = `<div class="muted">Ruta vacía. Añade paradas desde “Top candidatos”.</div>`;
      return;
    }

    box.innerHTML = ruta.stops.map((st, idx)=>{
      const c = clientes.find(x=>x.id===st.clienteId);
      const doneClass = st.done ? "done" : "";
      return `
        <div class="stop ${doneClass}" data-stop="${st.stopId}" data-cliente-id="${st.clienteId}">
          <div class="row">
            <div>
              <b>${idx+1}. ${escapeHtml(c?.nombre||"")}</b> <span class="muted">${escapeHtml(c?.empresa||"")}</span><br>
              <span class="mini">${escapeHtml(c?.zona||"")} · ${escapeHtml(c?.direccion||"")}</span>
            </div>
            <div class="right flex">
              <button class="btn btn-xs" data-act="up">↑</button>
              <button class="btn btn-xs" data-act="down">↓</button>
              <button class="btn btn-xs" data-act="done">${st.done ? "Reabrir" : "Hecho"}</button>
              <button class="btn-primary btn-xs" data-act="log">Registrar</button>
              <button class="btn-danger btn-xs" data-act="remove">Quitar</button>
            </div>
          </div>

          <label>Nota (solo ruta)</label>
          <input data-role="note" value="${escapeHtml(st.note||"")}">

          <div class="mini" style="margin-top:6px">
            Acceso rápido: ${escapeHtml(c?.telefono||"")} · ${escapeHtml(c?.email||"")}
          </div>
        </div>
      `;
    }).join("");

    // re-enganchar handlers (igual que renderRuta)
    box.onclick = async (e)=>{
      const b = e.target.closest("button");
      if(!b) return;
      const stopEl = e.target.closest(".stop");
      const stopId = stopEl?.dataset?.stop;
      if(!stopId) return;
      const act = b.dataset.act;
      if(act==="up") moveStop(stopId, -1);
      if(act==="down") moveStop(stopId, +1);
      if(act==="remove") removeStop(stopId);
      if(act==="done") toggleDone(stopId);
      if(act==="log") await logStop(stopId);
    };
    box.oninput = (e)=>{
      const inp = e.target.closest('input[data-role="note"]');
      if(!inp) return;
      const stopEl = e.target.closest(".stop");
      const stopId = stopEl?.dataset?.stop;
      if(!stopId) return;
      setStopNote(stopId, inp.value);
    };
  }

  function moveStop(stopId, dir){
    const ruta = getCurrentRutaObject();
    const idx = ruta.stops.findIndex(s=>s.stopId===stopId);
    if(idx<0) return;
    const j = idx + dir;
    if(j<0 || j>=ruta.stops.length) return;
    const tmp = ruta.stops[idx];
    ruta.stops[idx] = ruta.stops[j];
    ruta.stops[j] = tmp;
    renderRutaWithClientId(ruta);
  }

  function removeStop(stopId){
    const ruta = getCurrentRutaObject();
    ruta.stops = ruta.stops.filter(s=>s.stopId!==stopId);
    renderRutaWithClientId(ruta);
  }

  function toggleDone(stopId){
    const ruta = getCurrentRutaObject();
    const s = ruta.stops.find(x=>x.stopId===stopId);
    if(!s) return;
    s.done = !s.done;
    renderRutaWithClientId(ruta);
  }

  function setStopNote(stopId, note){
    const ruta = getCurrentRutaObject();
    const s = ruta.stops.find(x=>x.stopId===stopId);
    if(!s) return;
    s.note = note;
    // no re-render para no “saltar” el cursor
  }

  async function logStop(stopId){
    const ruta = getCurrentRutaObject();
    const st = ruta.stops.find(x=>x.stopId===stopId);
    if(!st) return;
    const clienteId = st.clienteId;
    const date = $("#rutaFecha").value || hoy;

    // Registrar interacción “visita” por defecto
    await dbPut("visitas", {
      id: uid(),
      clienteId,
      fecha: fromDateOnly(date),
      tipo: "visita",
      resultado: "ok",
      notas: st.note || "",
      creadoEn: nowISO()
    });

    // marcar como done
    st.done = true;
    renderRutaWithClientId(ruta);
    toast("Interacción registrada y parada marcada");
  }
}

/** =========================
 *  CLIENTES
 *  ========================= */
function renderClientes(el, clientes){
  el.innerHTML = `
    <div class="grid two">
      <div class="card">
        <h2>${STATE.editing?.type==="cliente" ? "Editar cliente" : "Nuevo cliente"}</h2>
        <form id="fCliente">
          <input type="hidden" name="id" value="${STATE.editing?.type==="cliente" ? STATE.editing.id : ""}">
          <label>Nombre</label><input name="nombre" required placeholder="Nombre y apellidos">
          <div class="grid two">
            <div><label>Apodo</label><input name="apodo" placeholder="Opcional"></div>
            <div><label>Empresa</label><input name="empresa" placeholder="Opcional"></div>
          </div>

          <div class="grid two">
            <div><label>Zona (para rutas)</label><input name="zona" placeholder="Ej: Pontevedra Centro, Vigo, ..."></div>
            <div><label>Horario preferido</label>
              <select name="horarioPreferido">
                <option value="">(sin especificar)</option>
                <option value="mañana">mañana</option>
                <option value="tarde">tarde</option>
                <option value="noche">noche</option>
              </select>
            </div>
          </div>

          <label>Dirección</label><input name="direccion" placeholder="Opcional">
          <div class="grid two">
            <div><label>Teléfono</label><input name="telefono" placeholder="Opcional"></div>
            <div><label>Email</label><input name="email" placeholder="Opcional"></div>
          </div>

          <label>Estado</label>
          <select name="estado">
            <option value="activo">activo</option>
            <option value="potencial">potencial</option>
            <option value="inactivo">inactivo</option>
          </select>

          <label>Frecuencia objetivo (días)</label><input name="frecuenciaObjetivoDias" type="number" min="0" placeholder="Ej: 21">

          <label>Etiquetas (separadas por coma)</label><input name="etiquetas" placeholder="alto volumen, recurrente">

          <label>Notas</label><textarea name="notas" placeholder="Preferencias, incidencias..."></textarea>

          <div class="flex">
            <button class="btn-primary" type="submit">Guardar</button>
            <button class="btn" type="button" id="cancelCliente">Cancelar</button>
          </div>
        </form>
      </div>

      <div class="card">
        <div class="row">
          <h2>Clientes (${clientes.length})</h2>
          <div class="right">
            <input id="qClientes" placeholder="Buscar..." style="min-width:220px">
          </div>
        </div>
        <div class="muted">Consejo: usa “Zona” para agrupar rutas (Vigo, Pontevedra Centro, etc.).</div>
        <div class="hr"></div>
        <div style="overflow:auto">
          <table id="tClientes">
            <thead><tr><th>Cliente</th><th>Zona</th><th>Estado</th><th></th></tr></thead>
            <tbody>
              ${clientes
                .sort((a,b)=> (a.nombre||"").localeCompare(b.nombre||""))
                .map(c=>`
                <tr data-id="${c.id}">
                  <td>
                    ${escapeHtml(c.nombre)} <span class="muted">${escapeHtml(c.apodo||"")}</span><br>
                    <span class="mini">${escapeHtml(c.empresa||"")}</span>
                  </td>
                  <td>${escapeHtml(c.zona||"")}</td>
                  <td><span class="pill ${c.estado==="activo"?"ok":(c.estado==="potencial"?"warn":"bad")}">${escapeHtml(c.estado||"")}</span></td>
                  <td class="right">
                    <button data-act="edit">Editar</button>
                    <button class="btn-danger" data-act="del">Borrar</button>
                  </td>
                </tr>`).join("")}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  `;

  const form = $("#fCliente");
  if(STATE.editing?.type==="cliente"){
    const c = clientes.find(x=>x.id===STATE.editing.id);
    if(c){
      form.nombre.value = c.nombre||"";
      form.apodo.value = c.apodo||"";
      form.empresa.value = c.empresa||"";
      form.zona.value = c.zona||"";
      form.horarioPreferido.value = c.horarioPreferido||"";
      form.direccion.value = c.direccion||"";
      form.telefono.value = c.telefono||"";
      form.email.value = c.email||"";
      form.estado.value = c.estado||"activo";
      form.frecuenciaObjetivoDias.value = c.frecuenciaObjetivoDias||"";
      form.etiquetas.value = (c.etiquetas||[]).join(", ");
      form.notas.value = c.notas||"";
      form.id.value = c.id;
    }
  }

  $("#cancelCliente").onclick = ()=>{ STATE.editing=null; render(); };

  form.onsubmit = async (e)=>{
    e.preventDefault();
    const id = form.id.value || uid();
    const obj = {
      id,
      nombre: form.nombre.value.trim(),
      apodo: form.apodo.value.trim(),
      empresa: form.empresa.value.trim(),
      zona: form.zona.value.trim(),
      horarioPreferido: form.horarioPreferido.value,
      direccion: form.direccion.value.trim(),
      telefono: form.telefono.value.trim(),
      email: form.email.value.trim(),
      estado: form.estado.value,
      frecuenciaObjetivoDias: Number(form.frecuenciaObjetivoDias.value||0),
      etiquetas: form.etiquetas.value.split(",").map(s=>s.trim()).filter(Boolean),
      notas: form.notas.value.trim(),
      creadoEn: STATE.editing ? (clientes.find(x=>x.id===id)?.creadoEn||nowISO()) : nowISO(),
      actualizadoEn: nowISO()
    };
    await dbPut("clientes", obj);
    toast("Cliente guardado");
    STATE.editing=null;
    render();
  };

  $("#tClientes").onclick = async (e)=>{
    const btn = e.target.closest("button");
    if(!btn) return;
    const tr = e.target.closest("tr");
    const id = tr?.dataset?.id;
    if(!id) return;
    const act = btn.dataset.act;
    if(act==="edit"){ STATE.editing={type:"cliente", id}; render(); }
    if(act==="del"){
      if(confirm("¿Borrar cliente? (no borra pedidos existentes)")){
        await dbDel("clientes", id);
        toast("Cliente borrado");
        render();
      }
    }
  };

  $("#qClientes").oninput = ()=>{
    const q = $("#qClientes").value.trim().toLowerCase();
    $$("#tClientes tbody tr").forEach(tr=>{
      const txt = tr.textContent.toLowerCase();
      tr.style.display = txt.includes(q) ? "" : "none";
    });
  };
}

/** =========================
 *  PRODUCTOS
 *  ========================= */
function renderProductos(el, productos){
  el.innerHTML = `
    <div class="grid two">
      <div class="card">
        <h2>${STATE.editing?.type==="producto" ? "Editar producto" : "Nuevo producto"}</h2>
        <form id="fProducto">
          <input type="hidden" name="id" value="${STATE.editing?.type==="producto" ? STATE.editing.id : ""}">
          <label>Nombre</label><input name="nombre" required placeholder="Nombre del producto">
          <label>Descripción</label><textarea name="descripcion" placeholder="Opcional"></textarea>
          <div class="grid two">
            <div><label>Categoría</label><input name="categoria" placeholder="Café, Cápsulas..."></div>
            <div><label>SKU / Código</label><input name="sku" placeholder="Opcional"></div>
          </div>
          <div class="grid two">
            <div><label>Precio</label><input name="precio" type="number" step="0.01" min="0" placeholder="Ej: 14.90"></div>
            <div><label>Coste (opcional)</label><input name="coste" type="number" step="0.01" min="0" placeholder="Ej: 8.10"></div>
          </div>
          <div class="grid two">
            <div><label>Unidad</label><input name="unidad" placeholder="ud, pack, kg..."></div>
            <div><label>IVA %</label><input name="iva" type="number" step="0.01" min="0" placeholder="Ej: 10"></div>
          </div>
          <label>Activo</label>
          <select name="activo">
            <option value="true">sí</option>
            <option value="false">no</option>
          </select>
          <div class="flex">
            <button class="btn-primary" type="submit">Guardar</button>
            <button class="btn" type="button" id="cancelProducto">Cancelar</button>
          </div>
        </form>
      </div>

      <div class="card">
        <div class="row">
          <h2>Productos (${productos.length})</h2>
          <div class="right">
            <input id="qProductos" placeholder="Buscar..." style="min-width:220px">
          </div>
        </div>
        <div class="hr"></div>
        <div style="overflow:auto">
          <table id="tProductos">
            <thead><tr><th>Producto</th><th>Categoría</th><th>Precio</th><th></th></tr></thead>
            <tbody>
              ${productos
                .sort((a,b)=> (a.nombre||"").localeCompare(b.nombre||""))
                .map(p=>`
                <tr data-id="${p.id}">
                  <td>${escapeHtml(p.nombre)} ${p.activo?``:`<span class="pill bad">inactivo</span>`}</td>
                  <td>${escapeHtml(p.categoria||"")}</td>
                  <td>${fmtEur(p.precio||0)}</td>
                  <td class="right">
                    <button data-act="edit">Editar</button>
                    <button class="btn-danger" data-act="del">Borrar</button>
                  </td>
                </tr>`).join("")}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  `;

  const form = $("#fProducto");
  if(STATE.editing?.type==="producto"){
    const p = productos.find(x=>x.id===STATE.editing.id);
    if(p){
      form.id.value=p.id;
      form.nombre.value=p.nombre||"";
      form.descripcion.value=p.descripcion||"";
      form.categoria.value=p.categoria||"";
      form.sku.value=p.sku||"";
      form.precio.value=p.precio??"";
      form.coste.value=p.coste??"";
      form.unidad.value=p.unidad||"";
      form.iva.value=p.iva??"";
      form.activo.value=String(!!p.activo);
    }
  }

  $("#cancelProducto").onclick = ()=>{ STATE.editing=null; render(); };

  form.onsubmit = async (e)=>{
    e.preventDefault();
    const id = form.id.value || uid();
    const obj = {
      id,
      nombre: form.nombre.value.trim(),
      descripcion: form.descripcion.value.trim(),
      categoria: form.categoria.value.trim(),
      sku: form.sku.value.trim(),
      precio: Number(form.precio.value||0),
      coste: Number(form.coste.value||0),
      unidad: form.unidad.value.trim(),
      iva: Number(form.iva.value||0),
      activo: form.activo.value==="true",
      creadoEn: STATE.editing ? (productos.find(x=>x.id===id)?.creadoEn||nowISO()) : nowISO(),
      actualizadoEn: nowISO()
    };
    await dbPut("productos", obj);
    toast("Producto guardado");
    STATE.editing=null;
    render();
  };

  $("#tProductos").onclick = async (e)=>{
    const btn = e.target.closest("button");
    if(!btn) return;
    const tr = e.target.closest("tr");
    const id = tr?.dataset?.id;
    if(!id) return;
    const act = btn.dataset.act;
    if(act==="edit"){ STATE.editing={type:"producto", id}; render(); }
    if(act==="del"){
      if(confirm("¿Borrar producto?")){
        await dbDel("productos", id);
        toast("Producto borrado");
        render();
      }
    }
  };

  $("#qProductos").oninput = ()=>{
    const q = $("#qProductos").value.trim().toLowerCase();
    $$("#tProductos tbody tr").forEach(tr=>{
      const txt = tr.textContent.toLowerCase();
      tr.style.display = txt.includes(q) ? "" : "none";
    });
  };
}

/** =========================
 *  PEDIDOS
 *  ========================= */
function renderPedidos(el, clientes, productos, pedidos){
  const clienteOpts = clientes
    .sort((a,b)=> (a.nombre||"").localeCompare(b.nombre||""))
    .map(c=>`<option value="${c.id}">${escapeHtml(c.nombre)}${c.empresa? " · " + escapeHtml(c.empresa):""}</option>`).join("");

  const productoOpts = productos
    .filter(p=>p.activo!==false)
    .sort((a,b)=> (a.nombre||"").localeCompare(b.nombre||""))
    .map(p=>`<option value="${p.id}" data-precio="${p.precio||0}">${escapeHtml(p.nombre)} (${fmtEur(p.precio||0)})</option>`).join("");

  el.innerHTML = `
    <div class="grid two">
      <div class="card">
        <h2>${STATE.editing?.type==="pedido" ? "Editar pedido" : "Nuevo pedido"}</h2>
        <form id="fPedido">
          <input type="hidden" name="id" value="${STATE.editing?.type==="pedido" ? STATE.editing.id : ""}">
          <label>Cliente</label>
          <select name="clienteId" required>
            <option value="" disabled selected>Selecciona...</option>
            ${clienteOpts}
          </select>

          <div class="grid two">
            <div><label>Fecha pedido</label><input name="fecha" type="date" required></div>
            <div><label>Fecha entrega (opcional)</label><input name="fechaEntrega" type="date"></div>
          </div>

          <div class="grid two">
            <div><label>Estado</label>
              <select name="estado">
                <option value="borrador">borrador</option>
                <option value="confirmado">confirmado</option>
                <option value="entregado">entregado</option>
                <option value="cancelado">cancelado</option>
              </select>
            </div>
            <div><label>Canal</label>
              <select name="canal">
                <option value="visita">visita</option>
                <option value="telefono">teléfono</option>
                <option value="whatsapp">whatsapp</option>
                <option value="email">email</option>
                <option value="otro">otro</option>
              </select>
            </div>
          </div>

          <label>Comercial</label><input name="comercial" placeholder="Opcional">
          <label>Notas</label><textarea name="notas" placeholder="Opcional"></textarea>

          <div class="hr"></div>
          <div class="row">
            <h2 style="margin:0">Líneas</h2>
            <button type="button" id="addLinea" class="btn-primary">+ Añadir línea</button>
          </div>
          <div id="lineas"></div>

          <div class="hr"></div>
          <div class="row">
            <div class="pill" id="totalPedido">Total: ${fmtEur(0)}</div>
            <div class="right flex">
              <button class="btn-primary" type="submit">Guardar</button>
              <button class="btn" type="button" id="cancelPedido">Cancelar</button>
            </div>
          </div>
        </form>
      </div>

      <div class="card">
        <div class="row">
          <h2>Pedidos (${pedidos.length})</h2>
          <div class="right">
            <input id="qPedidos" placeholder="Buscar..." style="min-width:220px">
          </div>
        </div>
        <div class="hr"></div>
        <div style="overflow:auto">
          <table id="tPedidos">
            <thead><tr><th>Fecha</th><th>Cliente</th><th>Estado</th><th>Total</th><th></th></tr></thead>
            <tbody>
              ${pedidos
                .slice()
                .sort((a,b)=> new Date(b.fecha)-new Date(a.fecha))
                .map(p=>{
                  const c = clientes.find(x=>x.id===p.clienteId);
                  const cls = p.estado==="entregado" ? "ok" : (p.estado==="confirmado"?"warn":(p.estado==="cancelado"?"bad":""));
                  return `<tr data-id="${p.id}">
                    <td>${fmtDate(p.fecha)}</td>
                    <td>${escapeHtml(c?.nombre||"")}</td>
                    <td><span class="pill ${cls}">${escapeHtml(p.estado||"")}</span></td>
                    <td>${fmtEur(p.total||0)}</td>
                    <td class="right">
                      <button data-act="edit">Editar</button>
                      <button class="btn-danger" data-act="del">Borrar</button>
                    </td>
                  </tr>`;
                }).join("")}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  `;

  const form = $("#fPedido");
  const lineasEl = $("#lineas");
  const totalEl = $("#totalPedido");

  function makeLineaRow(linea){
    const id = linea?.id || uid();
    const productoId = linea?.productoId || "";
    const cantidad = linea?.cantidad ?? 1;
    const precioUnit = linea?.precioUnit ?? 0;
    const descuentoPct = linea?.descuentoPct ?? 0;

    const row = document.createElement("div");
    row.className="card";
    row.style.margin="10px 0";
    row.dataset.id=id;
    row.innerHTML = `
      <div class="grid two">
        <div>
          <label>Producto</label>
          <select name="productoId" required>
            <option value="" disabled ${productoId? "":"selected"}>Selecciona...</option>
            ${productoOpts}
          </select>
        </div>
        <div class="grid two">
          <div><label>Cantidad</label><input name="cantidad" type="number" min="0" step="0.01" value="${cantidad}"></div>
          <div><label>Precio unit.</label><input name="precioUnit" type="number" min="0" step="0.01" value="${precioUnit}"></div>
        </div>
      </div>
      <div class="grid two">
        <div><label>Descuento %</label><input name="descuentoPct" type="number" min="0" step="0.01" value="${descuentoPct}"></div>
        <div class="row" style="justify-content:space-between;align-items:flex-end;">
          <div class="pill" data-role="lineTotal">Línea: ${fmtEur(0)}</div>
          <button type="button" class="btn-danger" data-act="remove">Quitar</button>
        </div>
      </div>
    `;

    const sel = row.querySelector('select[name="productoId"]');
    if(productoId) sel.value = productoId;

    sel.onchange = ()=>{
      const opt = sel.selectedOptions[0];
      const pr = Number(opt?.dataset?.precio||0);
      row.querySelector('input[name="precioUnit"]').value = pr;
      updateTotals();
    };

    row.oninput = ()=>updateTotals();
    row.onclick = (e)=>{
      const b = e.target.closest("button");
      if(b?.dataset?.act==="remove"){ row.remove(); updateTotals(); }
    };

    return row;
  }

  function readLineas(){
    const arr = [];
    $$("#lineas > div.card").forEach(row=>{
      const productoId = row.querySelector('select[name="productoId"]').value;
      const prod = productos.find(p=>p.id===productoId);
      const cantidad = Number(row.querySelector('input[name="cantidad"]').value||0);
      const precioUnit = Number(row.querySelector('input[name="precioUnit"]').value||0);
      const descuentoPct = Number(row.querySelector('input[name="descuentoPct"]').value||0);
      const l = {id: row.dataset.id, productoId, nombre: prod?.nombre||"", cantidad, precioUnit, descuentoPct, total:0};
      l.total = lineTotal(l);
      arr.push(l);
    });
    return arr.filter(l=>l.productoId);
  }

  function updateTotals(){
    const lineas = readLineas();
    $$("#lineas > div.card").forEach(row=>{
      const productoId = row.querySelector('select[name="productoId"]').value;
      if(!productoId) return;
      const cantidad = Number(row.querySelector('input[name="cantidad"]').value||0);
      const precioUnit = Number(row.querySelector('input[name="precioUnit"]').value||0);
      const descuentoPct = Number(row.querySelector('input[name="descuentoPct"]').value||0);
      const t = lineTotal({cantidad, precioUnit, descuentoPct});
      row.querySelector('[data-role="lineTotal"]').textContent = "Línea: " + fmtEur(t);
    });
    const total = lineas.reduce((a,l)=>a+Number(l.total||0),0);
    totalEl.textContent = "Total: " + fmtEur(total);
  }

  $("#addLinea").onclick = ()=>{
    lineasEl.appendChild(makeLineaRow());
    updateTotals();
  };

  $("#cancelPedido").onclick = ()=>{ STATE.editing=null; render(); };

  // Defaults
  form.fecha.value = isoDateOnly(new Date());
  form.estado.value = "borrador";
  form.canal.value = "visita";

  // Edit mode
  if(STATE.editing?.type==="pedido"){
    const p = pedidos.find(x=>x.id===STATE.editing.id);
    if(p){
      form.id.value = p.id;
      form.clienteId.value = p.clienteId;
      form.fecha.value = p.fecha ? new Date(p.fecha).toISOString().slice(0,10) : isoDateOnly(new Date());
      form.fechaEntrega.value = p.fechaEntrega ? new Date(p.fechaEntrega).toISOString().slice(0,10) : "";
      form.estado.value = p.estado || "borrador";
      form.canal.value = p.canal || "visita";
      form.comercial.value = p.comercial || "";
      form.notas.value = p.notas || "";

      lineasEl.innerHTML = "";
      (p.lineas||[]).forEach(l=> lineasEl.appendChild(makeLineaRow(l)));
      if((p.lineas||[]).length===0) lineasEl.appendChild(makeLineaRow());
      updateTotals();
    }
  } else {
    lineasEl.appendChild(makeLineaRow());
    updateTotals();
  }

  form.onsubmit = async (e)=>{
    e.preventDefault();
    const id = form.id.value || uid();
    const obj = {
      id,
      clienteId: form.clienteId.value,
      fecha: fromDateOnly(form.fecha.value),
      fechaEntrega: form.fechaEntrega.value ? fromDateOnly(form.fechaEntrega.value) : "",
      estado: form.estado.value,
      canal: form.canal.value,
      comercial: form.comercial.value.trim(),
      notas: form.notas.value.trim(),
      lineas: readLineas(),
      total: 0,
      creadoEn: STATE.editing ? (pedidos.find(x=>x.id===id)?.creadoEn||nowISO()) : nowISO(),
      actualizadoEn: nowISO()
    };
    recomputePedido(obj);
    await dbPut("pedidos", obj);
    toast("Pedido guardado");
    STATE.editing=null;
    render();
  };

  $("#tPedidos").onclick = async (e)=>{
    const btn = e.target.closest("button");
    if(!btn) return;
    const tr = e.target.closest("tr");
    const id = tr?.dataset?.id;
    if(!id) return;
    const act = btn.dataset.act;
    if(act==="edit"){ STATE.editing={type:"pedido", id}; render(); }
    if(act==="del"){
      if(confirm("¿Borrar pedido?")){
        await dbDel("pedidos", id);
        toast("Pedido borrado");
        render();
      }
    }
  };

  $("#qPedidos").oninput = ()=>{
    const q = $("#qPedidos").value.trim().toLowerCase();
    $$("#tPedidos tbody tr").forEach(tr=>{
      const txt = tr.textContent.toLowerCase();
      tr.style.display = txt.includes(q) ? "" : "none";
    });
  };
}

/** =========================
 *  INTERACCIONES
 *  ========================= */
function renderVisitas(el, clientes, visitas){
  const clienteOpts = clientes
    .sort((a,b)=> (a.nombre||"").localeCompare(b.nombre||""))
    .map(c=>`<option value="${c.id}">${escapeHtml(c.nombre)}${c.empresa? " · " + escapeHtml(c.empresa):""}</option>`).join("");

  el.innerHTML = `
    <div class="grid two">
      <div class="card">
        <h2>${STATE.editing?.type==="visita" ? "Editar interacción" : "Nueva interacción"}</h2>
        <form id="fVisita">
          <input type="hidden" name="id" value="${STATE.editing?.type==="visita" ? STATE.editing.id : ""}">
          <label>Cliente</label>
          <select name="clienteId" required>
            <option value="" disabled selected>Selecciona...</option>
            ${clienteOpts}
          </select>
          <div class="grid two">
            <div><label>Fecha</label><input name="fecha" type="date" required></div>
            <div><label>Tipo</label>
              <select name="tipo">
                <option value="visita">visita</option>
                <option value="llamada">llamada</option>
                <option value="whatsapp">whatsapp</option>
                <option value="email">email</option>
              </select>
            </div>
          </div>
          <label>Resultado</label>
          <select name="resultado">
            <option value="ok">ok</option>
            <option value="pendiente">pendiente</option>
            <option value="sin_respuesta">sin respuesta</option>
          </select>
          <label>Notas</label><textarea name="notas" placeholder="Qué se habló, próximos pasos..."></textarea>
          <div class="flex">
            <button class="btn-primary" type="submit">Guardar</button>
            <button class="btn" type="button" id="cancelVisita">Cancelar</button>
          </div>
        </form>
      </div>

      <div class="card">
        <div class="row">
          <h2>Interacciones (${visitas.length})</h2>
          <div class="right">
            <input id="qVisitas" placeholder="Buscar..." style="min-width:220px">
          </div>
        </div>
        <div class="hr"></div>
        <div style="overflow:auto">
          <table id="tVisitas">
            <thead><tr><th>Fecha</th><th>Cliente</th><th>Tipo</th><th>Resultado</th><th></th></tr></thead>
            <tbody>
              ${visitas
                .slice()
                .sort((a,b)=> new Date(b.fecha)-new Date(a.fecha))
                .map(v=>{
                  const c = clientes.find(x=>x.id===v.clienteId);
                  const cls = v.resultado==="ok" ? "ok" : (v.resultado==="pendiente"?"warn":"bad");
                  return `<tr data-id="${v.id}">
                    <td>${fmtDate(v.fecha)}</td>
                    <td>${escapeHtml(c?.nombre||"")}</td>
                    <td>${escapeHtml(v.tipo||"")}</td>
                    <td><span class="pill ${cls}">${escapeHtml(v.resultado||"")}</span></td>
                    <td class="right">
                      <button data-act="edit">Editar</button>
                      <button class="btn-danger" data-act="del">Borrar</button>
                    </td>
                  </tr>`;
                }).join("")}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  `;

  const form = $("#fVisita");

  // defaults
  form.fecha.value = isoDateOnly(new Date());
  form.tipo.value = "visita";
  form.resultado.value = "ok";

  if(STATE.editing?.type==="visita"){
    const v = visitas.find(x=>x.id===STATE.editing.id);
    if(v){
      form.id.value=v.id;
      form.clienteId.value=v.clienteId;
      form.fecha.value = v.fecha ? new Date(v.fecha).toISOString().slice(0,10) : isoDateOnly(new Date());
      form.tipo.value=v.tipo||"visita";
      form.resultado.value=v.resultado||"ok";
      form.notas.value=v.notas||"";
    }
  }

  $("#cancelVisita").onclick = ()=>{ STATE.editing=null; render(); };

  form.onsubmit = async (e)=>{
    e.preventDefault();
    const id = form.id.value || uid();
    const obj = {
      id,
      clienteId: form.clienteId.value,
      fecha: fromDateOnly(form.fecha.value),
      tipo: form.tipo.value,
      resultado: form.resultado.value,
      notas: form.notas.value.trim(),
      creadoEn: STATE.editing ? (visitas.find(x=>x.id===id)?.creadoEn||nowISO()) : nowISO(),
      actualizadoEn: nowISO()
    };
    await dbPut("visitas", obj);
    toast("Interacción guardada");
    STATE.editing=null;
    render();
  };

  $("#tVisitas").onclick = async (e)=>{
    const btn = e.target.closest("button");
    if(!btn) return;
    const tr = e.target.closest("tr");
    const id = tr?.dataset?.id;
    if(!id) return;
    const act = btn.dataset.act;
    if(act==="edit"){ STATE.editing={type:"visita", id}; render(); }
    if(act==="del"){
      if(confirm("¿Borrar interacción?")){
        await dbDel("visitas", id);
        toast("Interacción borrada");
        render();
      }
    }
  };

  $("#qVisitas").oninput = ()=>{
    const q = $("#qVisitas").value.trim().toLowerCase();
    $$("#tVisitas tbody tr").forEach(tr=>{
      const txt = tr.textContent.toLowerCase();
      tr.style.display = txt.includes(q) ? "" : "none";
    });
  };
}

/** =========================
 *  BACKUP (MEJORA #1)
 *  ========================= */
async function renderBackup(el){
  const backups = (await dbAll("backups")).sort((a,b)=> new Date(b.createdAt)-new Date(a.createdAt));
  const lastSnap = await dbGet("meta","lastSnapshotAt");
  const ready = await dbGet("meta","latestBackupReady");

  el.innerHTML = `
    ${ready?.value ? `
      <div class="banner">
        <div class="row">
          <div>
            <b>Backup automático listo</b>
            <div class="mini">Se creó un snapshot local y está listo para descargar/exportar cuando quieras.</div>
          </div>
          <div class="right">
            <button class="btn-primary" id="dlLatest">Descargar último</button>
          </div>
        </div>
      </div>
    ` : ""}

    <div class="grid two">
      <div class="card">
        <h2>Acciones</h2>
        <div class="muted">Exporta a JSON para guardarlo fuera (Drive/iCloud/PC) o restaura desde un JSON.</div>
        <div class="hr"></div>
        <div class="flex">
          <button class="btn-primary" id="btnExportAll">Exportar TODO ahora</button>
          <button class="btn" id="btnSnap">Crear snapshot local</button>
        </div>

        <div class="hr"></div>
        <div class="muted">
          Último snapshot: <b>${lastSnap?.value ? fmtDateTime(lastSnap.value) : "—"}</b>
        </div>
      </div>

      <div class="card">
        <h2>Importar (restaurar)</h2>
        <div class="muted">Carga un JSON exportado previamente. Ojo: reemplaza los datos actuales.</div>
        <div class="hr"></div>
        <input type="file" id="fileImport" accept="application/json">
        <div class="flex" style="margin-top:10px">
          <button class="btn-primary" id="btnImport">Importar</button>
          <button class="btn-danger" id="btnWipe">Borrar TODO</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <h2>Snapshots locales (${backups.length})</h2>
        <div class="right muted">Se guardan en el dispositivo. Puedes descargarlos o borrarlos.</div>
      </div>
      <div class="hr"></div>
      ${backups.length ? `
        <table id="tBackups">
          <thead><tr><th>Fecha</th><th>Motivo</th><th></th></tr></thead>
          <tbody>
            ${backups.map(b=>`
              <tr data-id="${b.id}">
                <td>${fmtDateTime(b.createdAt)}</td>
                <td>${escapeHtml(b.reason||"")}</td>
                <td class="right">
                  <button data-act="dl">Descargar</button>
                  <button class="btn-danger" data-act="del">Borrar</button>
                </td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      ` : `<div class="muted">Aún no hay snapshots. Crea uno o espera al auto-backup.</div>`}
    </div>
  `;

  async function downloadPayload(payload, filename){
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  $("#btnExportAll").onclick = async ()=>{
    const payload = {
      exportedAt: nowISO(),
      version: 1,
      clientes: await dbAll("clientes"),
      productos: await dbAll("productos"),
      pedidos: await dbAll("pedidos"),
      visitas: await dbAll("visitas"),
      rutas: await dbAll("rutas")
    };
    await downloadPayload(payload, "export_ventas_offline.json");
    toast("Export completo descargado");
    await dbPut("meta", {key:"latestBackupReady", value:false});
    updateBackupPill();
  };

  $("#btnSnap").onclick = async ()=>{
    await createSnapshot("manual");
    toast("Snapshot local creado");
    render(); // refresca tabla
  };

  const dlLatest = $("#dlLatest");
  if(dlLatest){
    dlLatest.onclick = async ()=>{
      const backups2 = (await dbAll("backups")).sort((a,b)=> new Date(b.createdAt)-new Date(a.createdAt));
      const latest = backups2[0];
      if(!latest) return toast("No hay snapshots");
      await downloadPayload(latest.payload, `snapshot_${latest.createdAt.replaceAll(":","-")}.json`);
      toast("Snapshot descargado");
      await dbPut("meta", {key:"latestBackupReady", value:false});
      updateBackupPill();
      render();
    };
  }

  $("#btnImport").onclick = async ()=>{
    const f = $("#fileImport").files[0];
    if(!f) return toast("Selecciona un archivo JSON");
    const txt = await f.text();
    let data;
    try{ data = JSON.parse(txt); } catch { return toast("JSON inválido"); }

    if(!confirm("Esto reemplazará tus datos actuales. ¿Continuar?")) return;

    // borrado
    await Promise.all([
      dbClear("clientes"), dbClear("productos"), dbClear("pedidos"), dbClear("visitas"), dbClear("rutas")
    ]);

    // carga (soporta export completo y snapshot)
    const clientes = data.clientes || data.payload?.clientes || [];
    const productos = data.productos || data.payload?.productos || [];
    const pedidos = data.pedidos || data.payload?.pedidos || [];
    const visitas = data.visitas || data.payload?.visitas || [];
    const rutas = data.rutas || data.payload?.rutas || [];

    for(const c of clientes) await dbPut("clientes", c);
    for(const p of productos) await dbPut("productos", p);
    for(const o of pedidos) await dbPut("pedidos", o);
    for(const v of visitas) await dbPut("visitas", v);
    for(const r of rutas) await dbPut("rutas", r);

    toast("Datos importados");
    setView("dash");
  };

  $("#btnWipe").onclick = async ()=>{
    if(!confirm("¿Borrar TODO? No se puede deshacer.")) return;
    await Promise.all([
      dbClear("clientes"), dbClear("productos"), dbClear("pedidos"), dbClear("visitas"), dbClear("rutas"), dbClear("backups")
    ]);
    await dbPut("meta",{key:"seeded", value:false});
    await dbPut("meta",{key:"latestBackupReady", value:false});
    toast("Datos borrados");
    updateBackupPill();
    setView("dash");
  };

  const tb = $("#tBackups");
  if(tb){
    tb.onclick = async (e)=>{
      const b = e.target.closest("button");
      if(!b) return;
      const tr = e.target.closest("tr");
      const id = tr?.dataset?.id;
      if(!id) return;
      const act = b.dataset.act;

      const snap = await dbGet("backups", id);
      if(!snap) return;

      if(act==="dl"){
        await downloadPayload(snap.payload, `snapshot_${snap.createdAt.replaceAll(":","-")}.json`);
        toast("Snapshot descargado");
        await dbPut("meta", {key:"latestBackupReady", value:false});
        updateBackupPill();
      }
      if(act==="del"){
        if(!confirm("¿Borrar snapshot?")) return;
        await dbDel("backups", id);
        toast("Snapshot borrado");
        render();
      }
    };
  }
}

/** =========================
 *  AJUSTES
 *  ========================= */
async function renderAjustes(el){
  const s = await loadSettings();
  el.innerHTML = `
    <div class="grid two">
      <div class="card">
        <h2>Auto-backup</h2>
        <div class="muted">Crea snapshots locales automáticamente. En iPad/iOS la descarga requiere un toque.</div>

        <label>Activado</label>
        <select id="abEnabled">
          <option value="true">sí</option>
          <option value="false">no</option>
        </select>

        <label>Cada cuántos días</label>
        <input id="abDays" type="number" min="1" max="60">

        <label>Conservar últimos N snapshots</label>
        <input id="abKeep" type="number" min="1" max="50">

        <div class="hr"></div>
        <button class="btn-primary" id="saveAjustes">Guardar ajustes</button>
        <button class="btn" id="makeSnap">Crear snapshot ahora</button>
      </div>

      <div class="card">
        <h2>Rutas</h2>
        <div class="muted">Ajustes rápidos del generador de rutas sugeridas.</div>

        <label>Nº paradas por defecto</label>
        <input id="rtStops" type="number" min="1" max="30">

        <label>Solo vencidos (días ≥ objetivo)</label>
        <select id="rtOnlyDue">
          <option value="true">sí</option>
          <option value="false">no</option>
        </select>

        <div class="hr"></div>
        <button class="btn-primary" id="saveRutas">Guardar rutas</button>
      </div>
    </div>
  `;

  $("#abEnabled").value = String(!!s.autoBackupEnabled);
  $("#abDays").value = Number(s.autoBackupEveryDays||7);
  $("#abKeep").value = Number(s.keepBackups||10);
  $("#rtStops").value = Number(s.routeDefaultStops||8);
  $("#rtOnlyDue").value = String(!!s.routeOnlyDue);

  $("#saveAjustes").onclick = async ()=>{
    await saveSetting("autoBackupEnabled", $("#abEnabled").value==="true");
    await saveSetting("autoBackupEveryDays", Number($("#abDays").value||7));
    await saveSetting("keepBackups", Number($("#abKeep").value||10));
    toast("Ajustes guardados");
  };

  $("#makeSnap").onclick = async ()=>{
    await createSnapshot("manual-from-settings");
    toast("Snapshot creado");
  };

  $("#saveRutas").onclick = async ()=>{
    await saveSetting("routeDefaultStops", Number($("#rtStops").value||8));
    await saveSetting("routeOnlyDue", $("#rtOnlyDue").value==="true");
    toast("Ajustes de rutas guardados");
  };
}

/** =========================
 *  Init
 *  ========================= */
(async function init(){
  await openDB();
  await ensureSeed();
  await setupPWA();
  await checkAutoBackup();
  await updateBackupPill();

  $$("nav button").forEach(b=> b.onclick = ()=> setView(b.dataset.view));

  // Vista inicial
  render();

  // Pequeño “latido”: re-check de auto-backup si la app está abierta mucho rato (cada 30 min)
  setInterval(()=>{ checkAutoBackup().catch(()=>{}); }, 30*60*1000);
})();
</script>
</body>
</html>
